services:
  # ============================================
  # CakePHP Application with Nginx + PHP-FPM
  # ============================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: development  # Use 'production' for prod builds
    container_name: soporte_app
    restart: unless-stopped
    ports:
      - "8765:80"  # Access via http://localhost:8765
    volumes:
      # Mount application code for hot-reload in development
      - .:/var/www/html:delegated
      # Persist logs
      - ./logs:/var/www/html/logs
      # Persist uploads
      - ./webroot/uploads:/var/www/html/webroot/uploads
      # Cache volumes (don't sync tmp to host for performance)
      - app_tmp:/var/www/html/tmp
    environment:
      # Application environment
      - APP_ENV=${APP_ENV:-development}
      - DEBUG=${DEBUG:-true}

      # Database connection (Supabase PostgreSQL)
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT:-5432}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}

      # Security
      - SECURITY_SALT=${SECURITY_SALT}

      # PHP Configuration
      - PHP_MEMORY_LIMIT=256M
      - PHP_UPLOAD_MAX_FILESIZE=10M
      - PHP_POST_MAX_SIZE=10M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# ============================================
# Volumes
# ============================================
volumes:
  app_tmp:
    driver: local
